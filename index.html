<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8"> 
    <meta content='width=device-width, initial-scale=1' name='viewport'/>
    <title>Mirliton</title>

<style>

@font-face {
    font-family: FuturaPTBook;
    src: url("./FuturaPTBook.otf") format("opentype");
}
@font-face {
    font-family: FuturaPTDemi;
    src: url("./FuturaPTDemi.otf") format("opentype");
}
    
body {
    font-family: FuturaPTBook, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-left: auto;
    margin-right: auto;
    padding: 20px;
    background-color: #f3e6de;
    max-width: 500px;
}

.texte {
    width = ;
    text-align: justify;
}

.tab-container {
    flex : 1;
    display : flex;
    flex-direction: column;
    width: 100%;
}

.inputs {
    display: flex;
    flex-direction: column;
}

.inputTitle {
    /*text-align: center;*/
    font-size:1em;
    font-family: FuturaPTDemi, sans-serif;
}

.inputTitleContainer {
    display: flex;
    flex-direction: row;
    align-items: center;
}

.popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

#b1, #b2, #b3, #b4{
    aspect-ratio: 1;
    margin-left : 5px;
    border-radius: 50%;
    border : 0px;
    background-color: white;
    margin-left: auto;
}

/* Conteneur de la popup */
.popup-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    max-width: 400px;
    width: 90%;
}

/* Bouton pour fermer la popup */
.close-btn {
    background: lightgrey;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 20px;
}

.close-btn:hover {
    background: grey;
}

.slider-container {
    margin-top: 0px;
    text-align: center;
    display: flex;
    flex-direction: row;
}

.slider {
    width: 100%;
    height: 10px;
    appearance: none;
    background: #ddd;
    border-radius: 50px;
    outline: none;
}

.slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    background: black;
    border-radius: 50%;
    cursor: pointer;
}

.slider::-moz-range-thumb { 
    width: 20px;
    height: 20px;
    background: #4CAF50;
    border-radius: 50%;
    cursor: pointer;
}

.value-display {
    margin-top: 5px;
    margin-left : 20px;
    font-size: 18px;
    font-weight: bold;
    transform: translateY(-13px);
}

.visuals {
  display : flex;
  flex :2;
  flex-direction: column;
  margin-top: 10px;
  width : 95%;
  height : 300px;
}

.circle{
    position: relative; /* Pour permettre un positionnement relatif des enfants */
    height : 300px;
    display: flex;
    justify-content: center; 
    align-items: center; 
}
.circleValue {
    font-family: FuturaPTDemi, sans-serif;
    font-size: 2em;
    text-align: center;
}
 
.circleLegende{
    font-weight: bold;
    font-size: 15px;  
    text-align: center;
}

.circleRCA {
    background: #fb551e;
    opacity: 0.85;
    border-radius: 50%;
    transform: translateX(50px); 
    height: 100px;
    width: 100px;
    display: flex; 
    flex-direction: column;
    justify-content: center; 
    align-items: center;
    position: relative;
    left: -25%;
}

.circleREBE {
    background: #622b59;
    opacity: 0.85;
    border-radius: 50%;
    transform: translateX(-50px); 
    height: 100px;
    width: 100px;
    display: flex; 
    flex-direction: column;
    justify-content: center; 
    align-items: center;
    position: relative; 
    left: 25%; 
}


.treso-container {
    width: 95%;
    height: 15px;
    margin-top: 5px;
    margin-bottom: 10px;
    border: 0px solid #333;
    position: relative;
}

.treso-fill {
    z-index: 1;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, rgba(255,72,0,1) 0%, rgba(250,255,64,1) 50%, rgba(0,167,8,1) 100%);
    /* background-color: #4CAF50; */
    border-radius: 10px;
    position: absolute;
    left: 0;
    transition: height 0.2s ease;
}

.euro-logo {
    height: 40px;
    width: 40px;
    position: absolute;
    z-index: 2;
    transform: translateY(-25%);
    font-size: 35px;
    font-weight: bold;
    color: black;
    transition: bottom 0.2s ease;
    background-color: white;
    border-radius: 50%;
    display: flex; 
    justify-content: center; 
    align-items: center; 
    }

.outputs-container {
    width: 99%;
    color: #000; 
    margin-top: 10px;
    display: flex;
    flex-flow: row wrap; /* Permet l'enroulement si nécessaire */
    justify-content: space-around;
}

.outputs {
    display: flex;
    flex-direction: column;
    align-items: center; 
    text-align: center;
    gap: 2px; /* Ajoute de l'espace entre les éléments */
}

.outputsRelative, .outputsAbsolute {
    display: inline-flex; /* Alignement en ligne */
    align-items: baseline; /* Aligne le bas des textes */
    gap: 2px; /* Ajoute de l'espace entre les deux */
}

.outputsRelative {
    font-family: FuturaPTDemi, sans-serif;
    font-size: 2em;
    color: red;
}

.outputsAbsolute {
    font-size: 1em;
    display: inline-block; /* Aligne en ligne avec outputsRelative */
}

.outputs:nth-child(4) {
    border-right: 2px solid black; /* Add a vertical line */
    margin-right: 2px; /* Optionnel : Espace après la ligne */
}
</style>
</head> 
<body> 
    <div>Introduction</div>
    <div class='texte' id='texte'>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed consectetur ultricies purus, eget varius enim sodales vel. Fusce non metus id magna ornare consequat. Proin consequat, mi sed lacinia cursus, turpis erat elementum magna, vel sagittis velit tortor in mauris. Sed lobortis neque vel dapibus dapibus. Nam vestibulum tincidunt velit, et maximus sem fringilla nec. Integer aliquet eget ipsum nec eleifend. Nulla vestibulum auctor magna, aliquam sodales ipsum euismod et. Duis pretium sem felis. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In sit amet nibh euismod, accumsan leo ut, tristique neque. Praesent condimentum convallis tortor eu bibendum. Fusce dictum lobortis posuere. Ut finibus porta nibh, at sodales diam fermentum vehicula. Etiam iaculis feugiat ultricies. Nam ac ullamcorper eros. Etiam blandit sapien vel ornare viverra
    </div>
    <div class="tab-container"> 
        <div id="Croissance" class='inputs'>
            <div class='inputTitleContainer'>
                <h3 class='inputTitle'>Croissance du chiffre d'affaires</h3>
                <button id="b1">?</button>
                <div id="popup1" class="popup-overlay">
                    <div class="popup-content">
                        <h2>Croissance du chiffre d'affaires</h2>
                        <p>Votre croissance peut contribuer au financement de votre transformation stratégique mais vous éloigne en revanche de vos objectifs socio-environnementaux</p>
                        <button class="close-btn" id="close-popup1">Fermer</button>
                    </div>
                </div>
            </div>
                <div class="slider-container">
                    <input type="range" min="0" max="100" value="0" step="1" class="slider" id="rangeSlider1">
                    <div class="value-display" id="sliderValue1">0%</div>
                </div>
        </div>

        <div id="Fournisseurs" class='inputs'>
            <div class='inputTitleContainer'>
                <h3 class='inputTitle'>Agriculture raisonnée et contrats longs</h3>
                <button id="b2">?</button>
                <div id="popup2" class="popup-overlay">
                    <div class="popup-content">
                        <h2>Agriculture raisonnée et contrats longs</h2>
                        <p>Vous accompagnez vos fournisseurs dans leur transition vers une agriculture plus raisonnée et signez des partenariats long terme leur assurant une juste rémunération</p>
                        <button class="close-btn" id="close-popup2">Fermer</button>
                    </div>
                </div>
            </div>
                <div class="slider-container">
                    <input type="range" min="0" max="100" value="0" step="1" class="slider" id="rangeSlider2">
                    <div class="value-display" id="sliderValue2">0%</div>
                </div>
        </div>

        <div id="PackagingTransport" class='inputs'>
            <div class='inputTitleContainer'>
                <h3 class='inputTitle'>Décarbonation du transport et éco-packaging</h3>
                <button id="b3">?</button>
                <div id="popup3" class="popup-overlay">
                    <div class="popup-content">
                        <h2>Décarbonation du transport et éco-packaging</h2>
                        <p>Vous optimisez votre chaine logistique en favorisant le fret ferroviaire. Pour les packagings, vous favorisez la consigne et l’éco-conception</p>
                        <button class="close-btn" id="close-popup3">Fermer</button>
                    </div>
                </div>
            </div>
            <div class="slider-container">
                <input type="range" min="0" max="100" value="0" step="1" class="slider" id="rangeSlider3">
                <div class="value-display" id="sliderValue3">0%</div>
            </div>
        </div>
        
        <div id="Redirection" class='inputs'>
            <div class='inputTitleContainer'>
                <h3 class='inputTitle'>Transition vers le végétal</h3>
                <button id="b4">?</button>
                <div id="popup4" class="popup-overlay">
                    <div class="popup-content">
                        <h2>Transition vers le végétal</h2>
                        <p>Vous réduisez la part de protéines animale dans vos produits et investissez en R&D dans des substituts «sains et végétariens»</p>
                        <button class="close-btn" id="close-popup4">Fermer</button>
                    </div>
                </div>
            </div>
            <div class="slider-container">
                <input type="range" min="0" max="100" value="0" step="1" class="slider" id="rangeSlider4">
                <div class="value-display" id="sliderValue4">0%</div>
            </div>
        </div>
    </div>

    <div class="visuals">
      <div class="treso-container">
        <div class="euro-logo" id="euroLogo">€</div>
        <div class="treso-fill" id="tresoEtat"></div>
      </div>
      <div class="circle"> 
            <div class="circleRCA" id='circleRCA'>   
                <div class='circleValue' id="RCA">0%</div>
                <div class='circleLegende'>Chiffre d'affaires</div>
            </div>
            <div class="circleREBE" id='circleREBE'>   
                <div class='circleValue' id="REBE">0%</div>
                <div class='circleLegende'>EBE</div>
            </div>
          
      </div>  
    </div>
    
    <div class="outputs-container">
        <div class="outputs">
          <div>Climat</div>
          <div class="outputsRelative" id="RCO2">0%</div>
          <div class="outputsAbsolute" id="ACO2">200 ktCO2e</div>
        </div>
        <div class="outputs">
          <div>Biodiversité</div>
          <div class="outputsRelative" id="RBiodiv">0%</div>
          <div class="outputsAbsolute" id="ABiodiv">impact sur les sols</div>
        </div>
        <div class="outputs">
          <div>Eau</div>
          <div class="outputsRelative" id="REau">0%</div>
          <div class="outputsAbsolute" id="AEau">1.5 Mm3</div>
        </div>
        <div class="outputs"></div>
        <div class="outputs">
          <div>Fournisseurs</div>
          <div class="outputsRelative" id="RFournisseurs">0%</div>
          <div class="outputsAbsolute" id="AFournisseurs">sur les revenus</div>
        </div>
    </div>
    <script>
      

// Appel au serveur

/*function callServer(rangeSlider1, rangeSlider2, rangeSlider3, rangeSlider4) {
    /*try {
        // Préparer la requête avec les données nécessaires
        const response = await fetch('/wp-json/calcul/v1/compute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                rangeSlider1,
                rangeSlider2,
                rangeSlider3,
                rangeSlider4,
            }),
        });

        // Vérifier si la réponse est correcte
        if (!response.ok) {
            const error = await response.json();
            console.error('Erreur du backend:', error.error || 'Requête invalide');
            return;
        }

        // Extraire les résultats de la réponse
        const data = await response.json();
        console.log('Résultats du calcul:', data);

        // Utiliser les résultats ici
        return data;
    } 
    catch (error) {
        console.error('Erreur de communication avec le serveur:', error);
    }
};*/


// Calcul
async function callServer(rangeSlider1, rangeSlider2, rangeSlider3, rangeSlider4) {
    try {
        const response = await fetch('calculBackend.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                rangeSlider1,
                rangeSlider2,
                rangeSlider3,
                rangeSlider4,
            }),
        });

        if (!response.ok) {
            throw new Error('Erreur lors de l\'appel au backend');
        }

        return await response.json();
    } catch (error) {
        console.error('Erreur:', error);
        return null;
    }
};

// Update des valeurs

function updateVariables(variables) {
    const elementIds = ['RCO2', 'ACO2', 'RBiodiv', 'REau', 'AEau', 'RFournisseurs','CA','RCA','EBE', 'REBE', 'reserve'];
     
    document.getElementById(elementIds[7]).textContent = `${variables[7]}%`;
    document.getElementById(elementIds[9]).textContent = `${variables[9]}%`;

    for (let index = 0; index < variables.length-1; index++) {
        const value = variables[index];
        const elementId = elementIds[index];
        const oldElement = document.getElementById(elementId);

        if (elementId.startsWith('R')) {
            oldElement.textContent = `${value}%`;
        } else { if (elementId.startsWith('ACO2')){
            oldElement.textContent = `${Math.round(value/1000)} ktCO2e`;
        }
        else { if (elementId.startsWith('AEau')) {
            oldElement.textContent = `${Math.round(value*100/1000000)/100} Mm3`;
        } else {
            oldElement.textContent = `${value}`;
                    }
                }
            } 
        }
    }

// Update des cercles 

function updateCircle(variables) {
    const circleRCA = document.getElementById('circleRCA');
    const circleREBE = document.getElementById('circleREBE');
    
    //let max = circle.style.height;
    
    let valueRCA = variables[7]/100;
    let valueREBE = variables[9]/100;
    
    circleRCA.style.width = `${50*(2+2*valueRCA)}px`; 
    circleRCA.style.height = `${50*(2+2*valueRCA)}px`;
    
    circleREBE.style.width = `${50*(2+2*valueREBE)}px`;
    circleREBE.style.height = `${50*(2+2*valueREBE)}px`;
     
    // Calcul du décalage nécessaire pour garder les cercles centrés
    let offsetRCA = 50*(2+2*valueRCA) / 2;
    let offsetREBE = -50*(2+2*valueREBE) / 2;

    // Appliquer les décalages avec 'transform' pour les centrer
    circleRCA.style.transform = `translateX(${offsetRCA}px)`;
    circleREBE.style.transform = `translateX(${offsetREBE}px)`;
    
}


// Update de la jauge

function updateGauge(reserve){
    // Sélection des éléments de la jauge
    const tresoEtat = document.getElementById('tresoEtat');
    const euroLogo = document.getElementById('euroLogo');
    
    // Fonction pour calculer la couleur en fonction du pourcentage
    function getColorFromPercentage(percent) {
        if (percent < 0) percent = 0;
        if (percent > 100) percent = 100;
        let red = Math.round(2*255 * (1 - percent / 100));
        let green = Math.round(2*255 * percent/100);
        return `rgb(${red}, ${green}, 0)`;
    }
    
    let pourcentage = reserve/260;
    // Ajuster la hauteur, la couleur et le logo selon le pourcentage
    if (pourcentage > 1) {
        // tresoEtat.style.width = 100 + '%';
        const cropValue = 0 + '%'; // Ex. "50%"
        tresoEtat.style.clipPath = `inset(0 ${cropValue} 0 0)`;
        euroLogo.style.left = 98 + '%';
    } else
    {
        // tresoEtat.style.width = reserve + '%';
        const cropValue = (1-pourcentage)*100 + '%'; // Ex. "50%"
        tresoEtat.style.clipPath = `inset(0 ${cropValue} 0 0)`;
        euroLogo.style.left = pourcentage*100-2 + '%';

    }
    //tresoEtat.style.backgroundColor = getColorFromPercentage(reserve);
}

// Objectifs sur les sorties 
function objectifs(variables){
    const objectifCO2 = -40;
    const objectifBiodiv =-30 ;
    const objectifEau =-15;
    const objectifFournisseurs =15;
    
    //const elementIds = ['RCO2', 'ACO2', 'RBiodiv', 'REau', 'AEau', 'RFournisseurs','CA','RCA','EBE', 'REBE', 'reserve'];
    
    let RCO2 = variables[0];
    let RBiodiv = variables[2];
    let REau = variables[3];
    let RFournisseurs = variables[5];

    
    if (RCO2 < objectifCO2){
        document.getElementById('RCO2').style.color = 'green';
    } else if (RCO2 > objectifCO2){
            document.getElementById('RCO2').style.color = 'red';
    }
    
    if (RBiodiv < objectifBiodiv){
        document.getElementById('RBiodiv').style.color = 'green';
    } else if (RBiodiv > objectifCO2){
            document.getElementById('RBiodiv').style.color = 'red';
    }
    
    if (REau < objectifEau){
        document.getElementById('REau').style.color = 'green';
    } else if (REau > objectifCO2){
            document.getElementById('REau').style.color = 'red';
    }
    
    if (RFournisseurs > objectifFournisseurs){
        document.getElementById('RFournisseurs').style.color = 'green';
    } else if (RFournisseurs > objectifCO2){
            document.getElementById('RFournisseurs').style.color = 'red';
    }
        
}

// Gestion des sliders
const rangeSlider1 = document.getElementById('rangeSlider1');
const sliderValue1 = document.getElementById('sliderValue1');
const rangeSlider2 = document.getElementById('rangeSlider2');
const sliderValue2 = document.getElementById('sliderValue2');
const rangeSlider3 = document.getElementById('rangeSlider3');
const sliderValue3 = document.getElementById('sliderValue3');
const rangeSlider4 = document.getElementById('rangeSlider4');
const sliderValue4 = document.getElementById('sliderValue4');


let locked = 1;
let lockedValue = [0,100,80,90];

rangeSlider1.addEventListener('input', async function () {
    const limitingValue = lockedValue[0];
    const currentInputs = [parseFloat(rangeSlider1.value), 
        parseFloat(rangeSlider2.value),
        parseFloat(rangeSlider3.value),
        parseFloat(rangeSlider4.value)];
    const currentValue = currentInputs[0];
    const newVariables = await callServer(...currentInputs);    
    
    if (locked && currentValue<limitingValue) {
        rangeSlider1.value = limitingValue;
        sliderValue1.textContent = `${limitingValue}%`;
    } else {
        sliderValue1.textContent = `${currentValue}%`;
        if (Math.round(newVariables.reserve) <= Math.round(0)){
            locked = 1;
        } else{
            locked = 0;
        }
        lockedValue = [...currentInputs];
        objectifs(Object.values(newVariables));
        updateCircle(Object.values(newVariables));
        updateGauge(newVariables.reserve);
        updateVariables(Object.values(newVariables));
        
        
    }
});

rangeSlider2.addEventListener('input', function () {
    const limitingValue = lockedValue[1];
    const currentInputs = [parseFloat(rangeSlider1.value), 
        parseFloat(rangeSlider2.value),
        parseFloat(rangeSlider3.value),
        parseFloat(rangeSlider4.value)];
    const currentValue = currentInputs[1];
    const newVariables = calculBackend(currentInputs[0],currentInputs[1],currentInputs[2],currentInputs[3]);
    
    if (locked && currentValue>limitingValue) {
        rangeSlider2.value = limitingValue;
        sliderValue2.textContent = `${limitingValue}%`;
    } else {
        sliderValue2.textContent = `${currentValue}%`;
        if (Math.round(newVariables[10]) <= Math.round(0)){
            locked = 1;
        } else{
            locked = 0;
        }
        lockedValue = [...currentInputs];
        objectifs(newVariables);
        updateCircle(newVariables);
        updateGauge(newVariables[10]);
        updateVariables(newVariables);
    }
});

rangeSlider3.addEventListener('input', function () {
    const limitingValue = lockedValue[2];
    const currentInputs = [parseFloat(rangeSlider1.value), 
        parseFloat(rangeSlider2.value),
        parseFloat(rangeSlider3.value),
        parseFloat(rangeSlider4.value)];
    const currentValue = currentInputs[2];
    const newVariables = calculBackend(currentInputs[0],currentInputs[1],currentInputs[2],currentInputs[3]);
    
    if (locked && currentValue>limitingValue) {
        rangeSlider3.value = limitingValue;
        sliderValue3.textContent = `${limitingValue}%`;
    } else {
        sliderValue3.textContent = `${currentValue}%`;
        if (Math.round(newVariables[10]) <= Math.round(0)){
            locked = 1;
        } else{
            locked = 0;
        }
        lockedValue = [...currentInputs];
        objectifs(newVariables);
        updateCircle(newVariables);
        updateGauge(newVariables[10]);
        updateVariables(newVariables);
        
    }
});

rangeSlider4.addEventListener('input', function () {
    const limitingValue = lockedValue[3];
    const currentInputs = [parseFloat(rangeSlider1.value), 
        parseFloat(rangeSlider2.value),
        parseFloat(rangeSlider3.value),
        parseFloat(rangeSlider4.value)];
    const currentValue = currentInputs[3];
    const newVariables = calculBackend(currentInputs[0],currentInputs[1],currentInputs[2],currentInputs[3]);
    
    if (locked && currentValue>limitingValue) {
        rangeSlider4.value = limitingValue;
        sliderValue4.textContent = `${limitingValue}%`;
    } else {
        sliderValue4.textContent = `${currentValue}%`;
        if (Math.round(newVariables[10]) <= Math.round(0)){
            locked = 1;
        } else{
            locked = 0;
        }
        lockedValue = [...currentInputs];
        objectifs(newVariables);
        updateCircle(newVariables);
        updateGauge(newVariables[10]);
        updateVariables(newVariables);
        
    }
});


// Pop-up

// Sélection des éléments HTML
const B1 = document.getElementById('b1');
const B2 = document.getElementById('b2');
const B3 = document.getElementById('b3');
const B4 = document.getElementById('b4');
const closePopupButton1 = document.getElementById('close-popup1');
const closePopupButton2 = document.getElementById('close-popup2');
const closePopupButton3 = document.getElementById('close-popup3');
const closePopupButton4 = document.getElementById('close-popup4');
const popup1 = document.getElementById('popup1');
const popup2 = document.getElementById('popup2');
const popup3 = document.getElementById('popup3');
const popup4 = document.getElementById('popup4');

// Ouvrir la popup
B1.addEventListener('click', () => {
  popup1.style.display = 'flex';
});
B2.addEventListener('click', () => {
  popup2.style.display = 'flex';
});
B3.addEventListener('click', () => {
  popup3.style.display = 'flex';
});
B4.addEventListener('click', () => {
  popup4.style.display = 'flex';
});

// Fermer la popup
closePopupButton1.addEventListener('click', () => {
  popup1.style.display = 'none';
});
closePopupButton2.addEventListener('click', () => {
  popup2.style.display = 'none';
});
closePopupButton3.addEventListener('click', () => {
  popup3.style.display = 'none';
});
closePopupButton4.addEventListener('click', () => {
  popup4.style.display = 'none';
});


// Fermer la popup en cliquant en dehors du contenu
popup1.addEventListener('click', (event) => {
  if (event.target === popup1) {
    popup1.style.display = 'none';
  }
});
popup2.addEventListener('click', (event) => {
  if (event.target === popup2) {
    popup2.style.display = 'none';
  }
});
popup3.addEventListener('click', (event) => {
  if (event.target === popup3) {
    popup3.style.display = 'none';
  }
});
popup4.addEventListener('click', (event) => {
  if (event.target === popup4) {
    popup4.style.display = 'none';
  }
});

// Initialisation

const newVariables = calculBackend(
    parseFloat(rangeSlider1.value),
    parseFloat(rangeSlider2.value),
    parseFloat(rangeSlider3.value),
    parseFloat(rangeSlider4.value)
);
updateGauge(newVariables[10]);
updateVariables(newVariables);
updateCircle(newVariables);
</script>
</body>
</html>
